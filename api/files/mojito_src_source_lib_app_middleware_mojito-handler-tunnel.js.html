<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>mojito_src&#x2F;source&#x2F;lib&#x2F;app&#x2F;middleware&#x2F;mojito-handler-tunnel.js - Mojito API</title>
    <link rel="stylesheet" href="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;3.5.0&#x2F;build&#x2F;cssgrids&#x2F;cssgrids-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/css/main.css" id="site_styles">
    <script src="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;3.5.0&#x2F;build&#x2F;yui&#x2F;yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="assets&#x2F;img&#x2F;mojito-logo-white-bkg.png" title="Mojito API"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.3.29</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="..&#x2F;classes/ActionContext.html">ActionContext</a></li>
            
                <li><a href="..&#x2F;classes/Analytics.common.html">Analytics.common</a></li>
            
                <li><a href="..&#x2F;classes/Assets.common.html">Assets.common</a></li>
            
                <li><a href="..&#x2F;classes/Carrier.common.html">Carrier.common</a></li>
            
                <li><a href="..&#x2F;classes/Composite.common.html">Composite.common</a></li>
            
                <li><a href="..&#x2F;classes/Config.common.html">Config.common</a></li>
            
                <li><a href="..&#x2F;classes/Cookie.client.html">Cookie.client</a></li>
            
                <li><a href="..&#x2F;classes/Cookie.server.html">Cookie.server</a></li>
            
                <li><a href="..&#x2F;classes/Deploy.server.html">Deploy.server</a></li>
            
                <li><a href="..&#x2F;classes/Device.common.html">Device.common</a></li>
            
                <li><a href="..&#x2F;classes/Http.server.html">Http.server</a></li>
            
                <li><a href="..&#x2F;classes/I13n.server.html">I13n.server</a></li>
            
                <li><a href="..&#x2F;classes/Intl.common.html">Intl.common</a></li>
            
                <li><a href="..&#x2F;classes/Meta.common.html">Meta.common</a></li>
            
                <li><a href="..&#x2F;classes/MojitoDispatcher.html">MojitoDispatcher</a></li>
            
                <li><a href="..&#x2F;classes/MojitoServer.html">MojitoServer</a></li>
            
                <li><a href="..&#x2F;classes/MojitProxy.html">MojitProxy</a></li>
            
                <li><a href="..&#x2F;classes/OutputAdapter.common.html">OutputAdapter.common</a></li>
            
                <li><a href="..&#x2F;classes/OutputHandler.html">OutputHandler</a></li>
            
                <li><a href="..&#x2F;classes/Params.common.html">Params.common</a></li>
            
                <li><a href="..&#x2F;classes/Partial.common.html">Partial.common</a></li>
            
                <li><a href="..&#x2F;classes/ResourceStore.server.html">ResourceStore.server</a></li>
            
                <li><a href="..&#x2F;classes/Url.common.html">Url.common</a></li>
            
                <li><a href="..&#x2F;classes/Y.mojito.Client.html">Y.mojito.Client</a></li>
            
                <li><a href="..&#x2F;classes/Y.mojito.lib.MojitoRouter.html">Y.mojito.lib.MojitoRouter</a></li>
            
                <li><a href="..&#x2F;classes/Y.mojito.lib.REST.html">Y.mojito.lib.REST</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="..&#x2F;modules/ActionContext.html">ActionContext</a></li>
            
                <li><a href="..&#x2F;modules/ActionContextAddon.html">ActionContextAddon</a></li>
            
                <li><a href="..&#x2F;modules/CommonLibs.html">CommonLibs</a></li>
            
                <li><a href="..&#x2F;modules/MojitoClient.html">MojitoClient</a></li>
            
                <li><a href="..&#x2F;modules/MojitoServer.html">MojitoServer</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: mojito_src&#x2F;source&#x2F;lib&#x2F;app&#x2F;middleware&#x2F;mojito-handler-tunnel.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&#x2F;*
 * Copyright (c) 2011-2012, Yahoo! Inc.  All rights reserved.
 * Copyrights licensed under the New BSD License.
 * See the accompanying LICENSE file for terms.
 *&#x2F;


&#x2F;*jslint anon:true, sloppy:true, nomen:true*&#x2F;


var liburl = require(&#x27;url&#x27;),
    logger,
    RX_MULTI_SLASH_ALL = &#x2F;\&#x2F;+&#x2F;g,
    Y = require(&#x27;yui&#x27;).YUI({useSync: true}).use(&#x27;json-parse&#x27;, &#x27;json-stringify&#x27;);

Y.applyConfig({useSync: false});


function trimSlash(str) {
    if (&#x27;&#x2F;&#x27; === str.charAt(str.length - 1)) {
        return str.substring(0, str.length - 1);
    }
    return str;
}


function TunnelServer() {}

&#x2F;*
* ResourceStoreAdapter will call expandInstance and the TunnelServer is what
* handles that. The header &#x27;x-mojito-header&#x27; (read here and set in
* store.client.js) tells the server not to try to route the URL, it gets handled
* by this critter. The targeted URL _might actually exist_ but we need to make
* sure that it _does not_ if the mojito header is set to &#x27;tunnel&#x27;.
*&#x2F;
TunnelServer.prototype = {

    handle: function(store, globalLogger) {
        var self = this,
            config;
        logger = globalLogger;
        &#x2F;&#x2F;console.log(&#x27;creating handle&#x27;);
        this._store = store;
        config = store.getAppConfig({}, &#x27;application&#x27;);
        this.tunnelPrefix = (config &amp;&amp; config.tunnelPrefix) ?
                config.tunnelPrefix :
                &#x27;&#x2F;tunnel&#x27;;
        this.staticPrefix = &#x27;&#x2F;static&#x27;;
        if (config &amp;&amp; config.staticHandling &amp;&amp;
                config.staticHandling.hasOwnProperty(&#x27;prefix&#x27;)) {
            this.staticPrefix = (config.staticHandling.prefix ?
                    &#x27;&#x2F;&#x27; + config.staticHandling.prefix :
                    &#x27;&#x27;);
        }
        this.tunnelPrefix = trimSlash(this.tunnelPrefix);
        this.staticPrefix = trimSlash(this.staticPrefix);
        if (!this.tunnelPrefix) {
            &#x2F;&#x2F; this makes the logic below a bit simpler
            this.tunnelPrefix = &#x27;&#x2F;&#x27;;
        }

        return function(req, res, next) {
            var url, parts;

            &#x2F;&#x2F; If we are not in a tunnel get out of here fast
            if (req.url.indexOf(self.tunnelPrefix) !== 0 &amp;&amp;
                    req.headers[&#x27;x-mojito-header&#x27;] !== &#x27;tunnel&#x27;) {
                return next();
            }

            url = req.url.replace(self.tunnelPrefix, &#x27;&#x27;).replace(
                self.staticPrefix,
                &#x27;&#x27;
            );
            url = url.replace(RX_MULTI_SLASH_ALL, &#x27;&#x2F;&#x27;);
            url = url.split(&#x27;?&#x27;)[0];
            parts = url.split(&#x27;&#x2F;&#x27;);

            if (parts.length === 4 &amp;&amp; parts[2] === &#x27;specs&#x27;) {
                return self._handleSpec(req, res, next, parts[1], parts[3]);
            }
            if (parts.length === 3 &amp;&amp; parts[2] === &#x27;definition.json&#x27;) {
                return self._handleType(req, res, next, parts[1]);
            }
            if (req.url === self.tunnelPrefix &amp;&amp; &#x27;POST&#x27; === req.method) {
                return self._handleRpc(req, res, next);
            }
            next();
        };
    },

    _handleSpec: function(req, res, next, type, basename) {

        var name,
            instance = {},
            that = this;

        name = basename.split(&#x27;.&#x27;).slice(0, -1).join(&#x27;.&#x27;) || null;

        if (!type || !name) {
            that._sendError(res, &#x27;Not found: &#x27; + req.url, 500);
            return;
        }

        instance.base = type;

        if (name !== &#x27;default&#x27;) {
            instance.base += &#x27;:&#x27; + name;
        }

        this._store.getSpec(&#x27;client&#x27;, instance.base, req.context,
            function(err, data) {
                if (err) {
                    that._sendError(res, &#x27;Error opening: &#x27; + req.url + &#x27;\n&#x27; +
                        err,
                        500
                        );
                    return;
                }
                that._sendData(res, data);
            });
    },

    _handleType: function(req, res, next, type) {

        var instance = {},
            that = this;

        if (!type) {
            that._sendError(res, &#x27;Not found: &#x27; + req.url, 500);
            return;
        }

        instance.type = type;

        this._store.getType(&#x27;client&#x27;, instance.type, req.context,
            function(err, data) {
                if (err) {
                    that._sendError(res, &#x27;Error opening: &#x27; + req.url + &#x27;\n&#x27; +
                        err,
                        &#x27;debug&#x27;,
                        &#x27;Tunnel:specs&#x27;
                        );
                    return;
                }
                that._sendData(res, data);
            });
    },

    _handleRpc: function(req, res, next) {
        var data = req.body,
            requestData = data.reqs[0],
            command = requestData.data;

        &#x2F;&#x2F; all we need to do is expand the instance given within the RPC call
        &#x2F;&#x2F; and attach it within a &quot;tunnelCommand&quot;, which will be handled by
        &#x2F;&#x2F; Mojito instead of looking up a route for it.
        this._store.expandInstance(command.instance, command.context,
            function(err, inst) {
                &#x2F;&#x2F; replace with the expanded instance
                command.instance = inst;
                req.command = {
                    instance: {
                        &#x2F;&#x2F; Magic here to delegate to daliProxy.
                        base: &#x27;daliProxy&#x27;
                    },
                    params: {
                        body: {
                            proxyCommand: command,
                            txId: requestData.txId
                        }
                    },
                    context: req.context
                };
                next();
            });
    },

    _sendError: function(res, msg, code) {
        this._sendData(res, {error: msg}, (code || 500));
    },

    _sendData: function(res, data, code) {
        res.writeHead((code || 200), {
            &#x27;content-type&#x27;: &#x27;application&#x2F;json; charset=&quot;utf-8&quot;&#x27;
        });
        res.end(Y.JSON.stringify(data, null, 4));
    }
};


&#x2F;**
 * Export a function which can create the handler.
 * @param {Object} config Data to configure the handler.
 * @return {Object} The newly constructed handler.
 *&#x2F;
module.exports = function(config) {
    var tunnel = new TunnelServer();
    return tunnel.handle(config.store, config.logger);
};

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="..&#x2F;assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="..&#x2F;assets/js/yui-prettify.js"></script>
<script src="..&#x2F;assets/../api.js"></script>
<script src="..&#x2F;assets/js/api-filter.js"></script>
<script src="..&#x2F;assets/js/api-list.js"></script>
<script src="..&#x2F;assets/js/api-search.js"></script>
<script src="..&#x2F;assets/js/apidocs.js"></script>
</body>
</html>
