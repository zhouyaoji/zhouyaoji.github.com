<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>mojito_src&#x2F;source&#x2F;lib&#x2F;app&#x2F;libs&#x2F;Mulib&#x2F;mu&#x2F;preprocessor.js - Mojito API</title>
    <link rel="stylesheet" href="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;3.5.0&#x2F;build&#x2F;cssgrids&#x2F;cssgrids-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/css/main.css" id="site_styles">
    <script src="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;3.5.0&#x2F;build&#x2F;yui&#x2F;yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="assets&#x2F;img&#x2F;mojito-logo-white-bkg.png" title="Mojito API"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.3.29</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="..&#x2F;classes/ActionContext.html">ActionContext</a></li>
            
                <li><a href="..&#x2F;classes/Analytics.common.html">Analytics.common</a></li>
            
                <li><a href="..&#x2F;classes/Assets.common.html">Assets.common</a></li>
            
                <li><a href="..&#x2F;classes/Carrier.common.html">Carrier.common</a></li>
            
                <li><a href="..&#x2F;classes/Composite.common.html">Composite.common</a></li>
            
                <li><a href="..&#x2F;classes/Config.common.html">Config.common</a></li>
            
                <li><a href="..&#x2F;classes/Cookie.client.html">Cookie.client</a></li>
            
                <li><a href="..&#x2F;classes/Cookie.server.html">Cookie.server</a></li>
            
                <li><a href="..&#x2F;classes/Deploy.server.html">Deploy.server</a></li>
            
                <li><a href="..&#x2F;classes/Device.common.html">Device.common</a></li>
            
                <li><a href="..&#x2F;classes/Http.server.html">Http.server</a></li>
            
                <li><a href="..&#x2F;classes/I13n.server.html">I13n.server</a></li>
            
                <li><a href="..&#x2F;classes/Intl.common.html">Intl.common</a></li>
            
                <li><a href="..&#x2F;classes/Meta.common.html">Meta.common</a></li>
            
                <li><a href="..&#x2F;classes/MojitoDispatcher.html">MojitoDispatcher</a></li>
            
                <li><a href="..&#x2F;classes/MojitoServer.html">MojitoServer</a></li>
            
                <li><a href="..&#x2F;classes/MojitProxy.html">MojitProxy</a></li>
            
                <li><a href="..&#x2F;classes/OutputAdapter.common.html">OutputAdapter.common</a></li>
            
                <li><a href="..&#x2F;classes/OutputHandler.html">OutputHandler</a></li>
            
                <li><a href="..&#x2F;classes/Params.common.html">Params.common</a></li>
            
                <li><a href="..&#x2F;classes/Partial.common.html">Partial.common</a></li>
            
                <li><a href="..&#x2F;classes/ResourceStore.server.html">ResourceStore.server</a></li>
            
                <li><a href="..&#x2F;classes/Url.common.html">Url.common</a></li>
            
                <li><a href="..&#x2F;classes/Y.mojito.Client.html">Y.mojito.Client</a></li>
            
                <li><a href="..&#x2F;classes/Y.mojito.lib.MojitoRouter.html">Y.mojito.lib.MojitoRouter</a></li>
            
                <li><a href="..&#x2F;classes/Y.mojito.lib.REST.html">Y.mojito.lib.REST</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="..&#x2F;modules/ActionContext.html">ActionContext</a></li>
            
                <li><a href="..&#x2F;modules/ActionContextAddon.html">ActionContextAddon</a></li>
            
                <li><a href="..&#x2F;modules/CommonLibs.html">CommonLibs</a></li>
            
                <li><a href="..&#x2F;modules/MojitoClient.html">MojitoClient</a></li>
            
                <li><a href="..&#x2F;modules/MojitoServer.html">MojitoServer</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: mojito_src&#x2F;source&#x2F;lib&#x2F;app&#x2F;libs&#x2F;Mulib&#x2F;mu&#x2F;preprocessor.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
var Path    = require(&#x27;path&#x27;),
        Mu = require(&#x27;..&#x2F;Mu&#x27;);

exports.expandPartials = expandPartials;
exports.expandPartialsFromMap = expandPartialsFromMap;
exports.clean = clean;
exports.check = check;
exports.rebuildLines = rebuildLines;
exports.rebuildSource = rebuildSource;

&#x2F;**
 * Preprocessor that is responsible for expanding partials in the AST.
 * 
 * @param {Parsed} parsed The parsed source.
 * @param {String} root The root that templates should be searched for from.
 * @param {String} ext The extension that should be added to filenames.
 * @param {Function} callback The callback to call when partials are expanded.
 *&#x2F;
function expandPartials(parsed, root, ext, callback) {
    process.nextTick(function () {
        var partials = getPartials(parsed);
        
        if (!partials.length) {
            return callback(undefined, parsed);
        }
        
        var actions = partials.map(function (partial) {
            return function (callback) {
                Mu.Parser.parse(partial, root, ext, callback);
            };
        });
        
        parallel(actions, function (results) {
            var partials = {};
            
            &#x2F;&#x2F; result.result[0] =&gt; the parsed partial
            &#x2F;&#x2F; result.result[1] =&gt; the filename of the partial
            
            results.forEach(function (result) {
                if (result.type === &#x27;success&#x27;) {
                    partials[result.result[1]] = result.result[0];
                }
            });
            
            callback(undefined, expandPartialsFromMap(parsed, partials));
        });
    });
}

&#x2F;**
 * Preprocessor that actually expands the partials into the parsed AST.
 * 
 * @param {Parsed} parsed The parsed source.
 * @param {Object} partials The partials to use to expand the parsed source.
 * @returns {Parsed} The expanded AST.
 *&#x2F;
function expandPartialsFromMap(parsed, partials) {
    return parsed.map(function (line) {
        var number = line.number;
        var source = line.source;
        var filename = line.filename;
        var tokens = line.tokens;
        
        tokens = tokens.map(function (token) {
            return token.type === &#x27;partial&#x27; ?
                {type: &#x27;partial&#x27;, value: partials[token.value] || []} : token;
        });
        
        return {
            number: number,
            source: source,
            filename: filename,
            tokens: tokens
        };
    });
}

&#x2F;**
 * Used to verify that the AST is well formed.
 * 
 * @param {Parsed} parsed The parsed source.
 * @returns {Parsed} The parsed source, untouched.
 * @throws {Error} If the source is not well formed.
 *&#x2F;
function check(parsed) {
    var stack = [];
    var lines = rebuildLines(parsed);
    
    parsed.forEach(function (line) {
        var tokens = line.tokens;
        
        tokens.forEach(function (token) {
            if (token.type === &#x27;start_enumerable&#x27; || token.type === &#x27;start_inverted_enumerable&#x27;) {
                stack.push({name: token.value, line: line});
            }
            
            if (token.type === &#x27;end_enumerable&#x27;) {
                if (!stack.length) {
                    var msg = &#x27;Parse Error: &#x27; + line.filename + &#x27;: unexpected enumerable end\n&#x27; +
                                        &#x27;    Line: &#x27; + line.number + &#x27; &gt; &#x27; + line.source.replace(&#x27;\\n&#x27;, &#x27;&#x27;) + &#x27;\n&#x27;;
                    
                    throw new Error(msg);
                }
                
                var last = stack.pop();
                if (last.name !== token.value) {
                    var msg = &#x27;Parse Error: &#x27; + line.filename + &#x27;: unmatched enumerable block\n&#x27; +
                                        &#x27;    Opening Tag - Line: &#x27; + last.line.number + &#x27; &gt; &#x27; + last.line.source.replace(&#x27;\\n&#x27;, &#x27;&#x27;) + &#x27;\n&#x27; +
                                        &#x27;    Closing Tag - Line: &#x27; + line.number + &#x27; &gt; &#x27; + line.source.replace(&#x27;\\n&#x27;, &#x27;&#x27;) + &#x27;\n&#x27;;
                    
                    throw new Error(msg);
                }
            }
            
        });
    });
    
    if (stack.length) {
        var last = stack.pop();
        var msg = &#x27;Parse Error: &#x27; + last.line.filename + &#x27;: unclosed enumerable open tag\n&#x27; +
                            &#x27;        &#x27; + (last.line.number-1) + &#x27;: &#x27; + (lines[last.line.number-2] || &#x27;&#x27;).replace(&#x27;\\n&#x27;, &#x27;&#x27;) + &#x27;\n&#x27; +
                            &#x27;    &gt; &#x27; + last.line.number + &#x27;: &#x27; + last.line.source.replace(&#x27;\\n&#x27;, &#x27;&#x27;) + &#x27;\n&#x27; +
                            &#x27;        &#x27; + (last.line.number+1) + &#x27;: &#x27; + (lines[last.line.number] || &#x27;_EOF_&#x27;).replace(&#x27;\\n&#x27;, &#x27;&#x27;) + &#x27;\n&#x27;;
        
        throw new Error(msg);
    }
    
    return parsed;
}

&#x2F;**
 * Preprocessor used to clean extra, useless, tokens from the AST. The parser
 * does a lazy job at ensuring it is perfectly generated, so this function
 * is used to remedy that.
 * 
 * It does the following:
 *     - Remove whitespace and newline when only a tag exists on a line.
 *     - Remove useless empty string tokens that the parser generates.
 *     - Escapes quotes in string tokens as to not break compiling.
 * 
 * @param {Parsed} parsed The parsed source to clean.
 * @returns {Parsed} The cleaned up parsed source. 
 *&#x2F;
function clean(parsed) {
    return parsed.map(function (line) {
        var number = line.number;
        var source = line.source;
        var filename = line.filename;
        var tokens = line.tokens;
        
        return {
            number: number,
            source: source,
            filename: filename,
            tokens: tokens.map(function (token, i) {
                &#x2F;&#x2F; Removes the whitespace and the newline if the only thing on this line
                &#x2F;&#x2F; is whitespace and a non variable tag.
                if (tokens.length === 2
                        &amp;&amp; i === 0
                        &amp;&amp; token.type === &#x27;string&#x27;
                        &amp;&amp; token.value.trim() === &#x27;\\n&#x27;
                        &amp;&amp; tokens[1].type !== &#x27;variable&#x27;
                        &amp;&amp; tokens[1].type !== &#x27;unescaped&#x27;
                        &amp;&amp; tokens[1].type !== &#x27;partial&#x27;) {
                    return null;
                }
                
                &#x2F;&#x2F; Recursively clean partials
                if (token.type === &#x27;partial&#x27;) {
                    return {type: &#x27;partial&#x27;, value: clean(token.value)};
                }
                
                &#x2F;&#x2F; removes useless empty strings
                if (token.type === &#x27;string&#x27; &amp;&amp; token.value === &#x27;&#x27;) {
                    return null;
                }
                
                &#x2F;&#x2F; escape quotes
                if (token.type === &#x27;string&#x27;) {
                    return {type: &#x27;string&#x27;, value: token.value.replace(&#x2F;&quot;&#x2F;g, &quot;\\\&quot;&quot;)};
                }
                
                return token;
            }).filter(filterFalsy)
        };
    });
}

&#x2F;**
 * Returns a list of the original source&#x27;s lines.
 * 
 * @param {Parsed} parsed The parsed source.
 * @returns {Array} The original source lines. 
 *&#x2F;
function rebuildLines(parsed) {
    return parsed.map(function (line) {
        return line.source;
    });
}

&#x2F;**
 * Returns the source in a string format.
 * 
 * @param {Parsed} parsed The parsed source.
 * @returns {String} The raw source that generated the parse tree. 
 *&#x2F;
function rebuildSource(parsed) {
    return rebuildLines(parsed).join(&#x27;\n&#x27;);
}


&#x2F;&#x2F; Private

&#x2F;**
 * Used with Array.filter to remove falsy items.
 *&#x2F;
function filterFalsy(item) {
    return item;
}

&#x2F;**
 * Gets a list of all partial names in the parsed tree.
 * 
 * FIXME: returns duplicates if the name appears multiple times.
 * 
 * @param {Parsed} parsed The parsed source.
 * @returns {Array} List of the partial names found.
 *&#x2F;
function getPartials(parsed) {
    var partials = parsed.map(function (line) {
        return line.tokens.map(function (token) {
            return token.type === &#x27;partial&#x27; &amp;&amp; typeof(token.value) === &#x27;string&#x27; ?
                token.value : null;
        }).filter(filterFalsy);
    }).filter(filterFalsy);
    
    return flatten2D(partials);
}

&#x2F;**
 * Flattens a two dimensional array.
 * 
 * @param {Array} arr The array of arrays to flatten.
 * @returns {Array} The flattened array.
 *&#x2F;
function flatten2D(arr) {
    return Array.prototype.concat.apply([], arr);
}


function parallel(callbacks, callback) {
    var results = [];
    
    var acc = function (err) {
        var result = Array.prototype.slice.call(arguments, 1);
        
        results.push({
            type: err ? &#x27;error&#x27; : &#x27;success&#x27;,
            result: err || result
        });
        
        if (results.length === callbacks.length) {
            callback(results);
        }
    };
    
    callbacks.forEach(function (cb) {
        cb(acc);
    });
}

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="..&#x2F;assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="..&#x2F;assets/js/yui-prettify.js"></script>
<script src="..&#x2F;assets/../api.js"></script>
<script src="..&#x2F;assets/js/api-filter.js"></script>
<script src="..&#x2F;assets/js/api-list.js"></script>
<script src="..&#x2F;assets/js/api-search.js"></script>
<script src="..&#x2F;assets/js/apidocs.js"></script>
</body>
</html>
