<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>mojito_src&#x2F;source&#x2F;lib&#x2F;app&#x2F;autoload&#x2F;dispatch.common.js - Mojito API</title>
    <link rel="stylesheet" href="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;3.5.0&#x2F;build&#x2F;cssgrids&#x2F;cssgrids-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/css/main.css" id="site_styles">
    <script src="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;3.5.0&#x2F;build&#x2F;yui&#x2F;yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="assets&#x2F;img&#x2F;mojito-logo-white-bkg.png" title="Mojito API"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.3.29</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="..&#x2F;classes/ActionContext.html">ActionContext</a></li>
            
                <li><a href="..&#x2F;classes/Analytics.common.html">Analytics.common</a></li>
            
                <li><a href="..&#x2F;classes/Assets.common.html">Assets.common</a></li>
            
                <li><a href="..&#x2F;classes/Carrier.common.html">Carrier.common</a></li>
            
                <li><a href="..&#x2F;classes/Composite.common.html">Composite.common</a></li>
            
                <li><a href="..&#x2F;classes/Config.common.html">Config.common</a></li>
            
                <li><a href="..&#x2F;classes/Cookie.client.html">Cookie.client</a></li>
            
                <li><a href="..&#x2F;classes/Cookie.server.html">Cookie.server</a></li>
            
                <li><a href="..&#x2F;classes/Deploy.server.html">Deploy.server</a></li>
            
                <li><a href="..&#x2F;classes/Device.common.html">Device.common</a></li>
            
                <li><a href="..&#x2F;classes/Http.server.html">Http.server</a></li>
            
                <li><a href="..&#x2F;classes/I13n.server.html">I13n.server</a></li>
            
                <li><a href="..&#x2F;classes/Intl.common.html">Intl.common</a></li>
            
                <li><a href="..&#x2F;classes/Meta.common.html">Meta.common</a></li>
            
                <li><a href="..&#x2F;classes/MojitoDispatcher.html">MojitoDispatcher</a></li>
            
                <li><a href="..&#x2F;classes/MojitoServer.html">MojitoServer</a></li>
            
                <li><a href="..&#x2F;classes/MojitProxy.html">MojitProxy</a></li>
            
                <li><a href="..&#x2F;classes/OutputAdapter.common.html">OutputAdapter.common</a></li>
            
                <li><a href="..&#x2F;classes/OutputHandler.html">OutputHandler</a></li>
            
                <li><a href="..&#x2F;classes/Params.common.html">Params.common</a></li>
            
                <li><a href="..&#x2F;classes/Partial.common.html">Partial.common</a></li>
            
                <li><a href="..&#x2F;classes/ResourceStore.server.html">ResourceStore.server</a></li>
            
                <li><a href="..&#x2F;classes/Url.common.html">Url.common</a></li>
            
                <li><a href="..&#x2F;classes/Y.mojito.Client.html">Y.mojito.Client</a></li>
            
                <li><a href="..&#x2F;classes/Y.mojito.lib.MojitoRouter.html">Y.mojito.lib.MojitoRouter</a></li>
            
                <li><a href="..&#x2F;classes/Y.mojito.lib.REST.html">Y.mojito.lib.REST</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="..&#x2F;modules/ActionContext.html">ActionContext</a></li>
            
                <li><a href="..&#x2F;modules/ActionContextAddon.html">ActionContextAddon</a></li>
            
                <li><a href="..&#x2F;modules/CommonLibs.html">CommonLibs</a></li>
            
                <li><a href="..&#x2F;modules/MojitoClient.html">MojitoClient</a></li>
            
                <li><a href="..&#x2F;modules/MojitoServer.html">MojitoServer</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: mojito_src&#x2F;source&#x2F;lib&#x2F;app&#x2F;autoload&#x2F;dispatch.common.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&#x2F;*
 * Copyright (c) 2011-2012, Yahoo! Inc.  All rights reserved.
 * Copyrights licensed under the New BSD License.
 * See the accompanying LICENSE file for terms.
 *&#x2F;


&#x2F;*jslint anon:true, sloppy:true, nomen:true*&#x2F;
&#x2F;*global YUI*&#x2F;


&#x2F;**
 * This object is responsible for running mojits.
 * @class MojitoDispatcher
 * @constructor
 * @param {ServerStore} resourceStore the store to use.
 * @private
 *&#x2F;
YUI.add(&#x27;mojito-dispatcher&#x27;, function(Y, NAME) {

    var loader,
        logger,
        store,
        CACHE = {
            YUI: {},
            controllerContexts: {}
        },
        &#x2F;&#x2F; TODO: [Issue 112] remove client detection logic
        cacheControllerContext = (typeof window !== &#x27;undefined&#x27;),
        coreYuiModules = [],
        usePrecomputed,
        useOnDemand,
        appShareYUIInstance;


    &#x2F;**
     * Modifies the YUI modules in the instance to point to the correct
     * language.
     *
     * @method fixupInstanceLang
     * @param {string} lang target language.
     * @param {Object} instance mojit instance (results of expandInstance()).
     * @private
     *&#x2F;
    function fixupInstanceLang(type, lang, instance) {
        var fixedSorted = [],
            fixedSortedPaths = {},
            bestLang = Y.Intl.lookupBestLang(lang,
                Y.Object.keys(instance.yui.langs)),
            suffix = (bestLang) ? &#x27;_&#x27; + bestLang : &#x27;&#x27;,
            OK = {},
            fixedMod,
            fixedPath;

        &#x2F;&#x2F; hard fallbacks if no &quot;root&quot; bundle
        if (!bestLang &amp;&amp; !instance.yui.langs[&#x27;&#x27;]) {
            if (instance.yui.langs.en) {
                bestLang = &#x27;en&#x27;;
                suffix = &#x27;_en&#x27;;
            }
            if (!bestLang &amp;&amp; instance.yui.langs[&#x27;en-US&#x27;]) {
                bestLang = &#x27;en-US&#x27;;
                suffix = &#x27;_en-US&#x27;;
            }
        }

        OK[&#x27;lang&#x2F;&#x27; + type + suffix] = true;
        if (suffix) {
            OK[&#x27;lang&#x2F;datatype-date-format&#x27; + suffix] = true;
        } else {
            &#x2F;&#x2F; The &quot;root&quot; (no lang) version doesn&#x27;t contain aggregates like %x.
            OK[&#x27;lang&#x2F;datatype-date-format_en&#x27;] = true;
        }

        Y.Array.each(instance.yui.sorted, function(mod) {
            if (&#x27;lang&#x2F;&#x27; === mod.substring(0, 5)) {
                if (OK[mod]) {
                    fixedSorted.push(mod);
                }
            } else {
                fixedSorted.push(mod);
            }
        });
        Y.Object.each(instance.yui.sortedPaths, function(path, mod) {
            if (&#x27;lang&#x2F;&#x27; === mod.substring(0, 5)) {
                if (OK[mod]) {
                    fixedSortedPaths[mod] = path;
                }
            } else {
                fixedSortedPaths[mod] = path;
            }
        });

        instance.yui.sorted = fixedSorted;
        instance.yui.sortedPaths = fixedSortedPaths;
    }


    &#x2F;* Optimization methods:

    ============ 1). YUI({bootstrap:false}).use(&#x27;*&#x27;)

    You&#x27;ll get optimal performance by adding the js files (in order) to the
    page, and using YUI({bootstrap:false}).use(&#x27;*&#x27;) instead of
    Y.use(moduleList).

    This will stop loader from calculating dependencies and assume everything
    which is required is already on the page.
    Additionally adding the scripts in order will mean there&#x27;s less re-sorting
    which needs to be done as each module gets attached.

    POTENTIAL ISSUE:
    For mojito, since you have multiple Y instances, Y.use(&#x27;*&#x27;) may be a
    concern - since it&#x27;s saying use everything currently on the page, so all
    your mojit instances will have all your modules attached.
    However, you could still use this for the global mojito framework Y
    instance, or for the shared modules (modules common to all mojits) and then
    use Y.use(additionalModules) for the rest.

    ============ 2). YUI({bootstrap:false}).use(sortedModuleList)
    The next step down in terms of performance would be to use
    YUI({bootstrap:false}).use(sortedModuleList) instead of Y.use(&#x27;*&#x27;), so you
    still have instances with separate modules, but there&#x27;s less (re)sorting
    required while attaching.

    ============ 3).
    You could also set the sorted list of shared modules (modules common to all
    mojits) as the core modules required for *ALL* your Y instances, using the
    core config property:

    http:&#x2F;&#x2F;developer.yahoo.com&#x2F;yui&#x2F;3&#x2F;api&#x2F;config.html#property_core

    It seems like 3 would be the easiest first optimization step to get in
    place to see if it provides benefits.
    *&#x2F;

    &#x2F;* See docs for the dispatch function in action-context.common.js *&#x2F;
    function dispatch(command, adapter) {
        logger.log(&#x27;dispatching command for &#x27; +
            (command.instance.base || &#x27;@&#x27; + command.instance.type) + &#x27;.&#x27; +
            command.action, &#x27;mojito&#x27;, &#x27;qeperf&#x27;);
        var instance = command.instance,
            cc = cacheControllerContext ?
                    CACHE.controllerContexts[instance.instanceId] :
                    null;

        if (cc) {
            logger.log(&#x27;using cached controller context: &#x27; +
                instance.instanceId, &#x27;info&#x27;, NAME);
            cc.invoke(command, adapter);
            return;
        }

        logger.log(&#x27;expanding partial mojit instance&#x27;, &#x27;mojito&#x27;, &#x27;qeperf&#x27;);

        &#x2F;&#x2F; Convert the command partial instance to a full instance. Note
        &#x2F;&#x2F; instance here means dictionary that&#x27;s either fully populated or
        &#x2F;&#x2F; not. When it&#x27;s expanded it contains all the data from the resource
        &#x2F;&#x2F; store which is needed to ensure it can be invoked&#x2F;dispatched.
        store.expandInstance(command.instance, command.context,
            function(err, instance) {

                &#x2F;&#x2F; if there is no action, make &#x27;index&#x27; the default
                if (!command.action) {
                    &#x2F;&#x2F; use instance config for default action or &#x27;index&#x27;
                    command.action = instance.action || &#x27;index&#x27;;
                }

                var instanceYuiCacheKey,
                    instanceYuiCacheObj,
                    ctxKey;

                if (err) {
                    if (adapter.error) {
                        adapter.error(err);
                    } else {
                        logger.log(&#x27;WARNING!! Uncaught error from dispatch&#x27; +
                            &#x27; on instance \&#x27;&#x27; + (command.instance.id || &#x27;@&#x27; +
                            command.instance.type) + &#x27;\&#x27;&#x27;, &#x27;error&#x27;, NAME);
                        logger.log(err.message, &#x27;error&#x27;, NAME);
                        logger.log(err.stack, &#x27;error&#x27;, NAME);
                        &#x2F;&#x2F; TODO: [Issue 67] adapter.done() so the
                        &#x2F;&#x2F; request doesn&#x27;t hang open.
                    }
                    return;
                }

                logger.log(&#x27;mojit instance expansion complete: &#x27; +
                    instance.instanceId, &#x27;mojito&#x27;, &#x27;qeperf&#x27;);

                &#x2F;&#x2F; We replace the given instance with the expanded instance
                command.instance = instance;

                if (appShareYUIInstance &amp;&amp; instance.shareYUIInstance) {
                    instanceYuiCacheKey = &#x27;singleton&#x27;;
                } else {
                    &#x2F;&#x2F; Generate a cache key
                    &#x2F;&#x2F; TODO: [Issue 68] Can we create this key
                    &#x2F;&#x2F; faster? from the request contextualizer?
                    instanceYuiCacheKey = [];
                    for (ctxKey in command.context) {
                        if (command.context.hasOwnProperty(ctxKey) &amp;&amp;
                                command.context[ctxKey]) {
                            instanceYuiCacheKey.push(ctxKey + &#x27;=&#x27; +
                                command.context[ctxKey]);
                        }
                    }
                    instanceYuiCacheKey = instance.type + &#x27;?&#x27; +
                        instanceYuiCacheKey.join(&#x27;&amp;&#x27;);
                }


                function runMojit() {
                    var moduleList,
                        mojitYuiModules;

                    fixupInstanceLang(command.instance.type, command.context.lang, instance);

                    moduleList = (usePrecomputed ?
                            instance.yui.sorted :
                            instance.yui.requires);
                    &#x2F;&#x2F; gotta copy this or else it pollutes the client runtime
                    mojitYuiModules = Y.mojito.util.copy(moduleList);

                    &#x2F;&#x2F; We are set so log our final list and use() it
                    logger.log(&#x27;Dispatching an instance of \&#x27;&#x27; +
                        (instance.id || &#x27;@&#x27; + instance.type) + &#x27;&#x2F;&#x27; +
                        command.action + &#x27;\&#x27; with the modules: [&#x27; +
                        mojitYuiModules.join(&#x27;, &#x27;) + &#x27;]&#x27;, &#x27;info&#x27;, NAME);

                    logger.log(&#x27;dispatching instance of \&#x27;&#x27; +
                        instance.instanceId + &#x27;&#x2F;&#x27; + command.action + &#x27;\&#x27;&#x27;,
                        &#x27;mojito&#x27;,
                        &#x27;qeperf&#x27;
                        );

                    &#x2F;&#x2F; Create the function that will be called in YUI().use()
                    &#x2F;&#x2F; pushing the runner function onto the tail of the YUI
                    &#x2F;&#x2F; module listing
                    mojitYuiModules.push(function(MOJIT_Y) {
                        logger.log(&#x27;YUI used: &#x27; + instance.instanceId,
                            &#x27;mojito&#x27;,
                            &#x27;qeperf&#x27;);

                        logger.log(&#x27;Creating controller context&#x27;, &#x27;info&#x27;,
                            NAME);
                        cc = new Y.mojito.ControllerContext({
                            instance: instance,
                            Y: MOJIT_Y,
                            store: store,
                            appShareYUIInstance: appShareYUIInstance,
                            dispatch: dispatch
                        });
                        logger.log(&#x27;caching controller context: &#x27; +
                            instance.instanceId, &#x27;info&#x27;, NAME);
                        if (cacheControllerContext) {
                            CACHE.controllerContexts[instance.instanceId] = cc;
                        }

                        cc.invoke(command, adapter);

                    });

                    &#x2F;&#x2F; Time marker
                    Y.mojito.perf.mark(&#x27;mojito&#x27;, &#x27;core_dispatch_start[&#x27; +
                        (instance.id || &#x27;@&#x27; + instance.type) + &#x27;:&#x27; +
                        command.action + &#x27;]&#x27;, &#x27;Dispatching an instance of \&#x27;&#x27; +
                        (instance.id || &#x27;@&#x27; + instance.type) + &#x27;&#x2F;&#x27; +
                        command.action + &#x27;\&#x27;&#x27;);

                    &#x2F;&#x2F; Now we call YUI use() with our modules array
                    &#x2F;&#x2F; This is the same as doing; YUI().use(arrayOfModules,
                    &#x2F;&#x2F; function(Y){});

                    &#x2F;&#x2F; Although Y.use should be asynch, it is not entirely
                    &#x2F;&#x2F; asynch. The files are read asynch, but the loader
                    &#x2F;&#x2F; calculations are not.

                    &#x2F;&#x2F; Putting this use statement within setTimeout apparently
                    &#x2F;&#x2F; prevents it from blocking the event loop, but it can
                    &#x2F;&#x2F; also execute the runner function against a different
                    &#x2F;&#x2F; request.

                    logger.log(&#x27;YUI use: &#x27; + instance.instanceId, &#x27;mojito&#x27;,
                        &#x27;qeperf&#x27;);

                    instanceYuiCacheObj.use.apply(instanceYuiCacheObj,
                        mojitYuiModules);
                }


                function modulesLoaded(cb) {

                    var groups = {},
                        groupKey = &#x27;mojit-&#x27; + instance.type,
                        instanceYuiConfig;

                    &#x2F;&#x2F; TODO: [Issue 69] Replace the mojit groups
                    &#x2F;&#x2F; defined in index.js&#x27;s configureYUI() function with
                    &#x2F;&#x2F; this?

                    &#x2F;&#x2F;logger.log(&#x27;YUI instance creation: &#x27; +
                    &#x2F;&#x2F;    instance.instanceId, mojito&#x27;, &#x27;qeperf&#x27;);

                    instanceYuiCacheObj = CACHE.YUI[instanceYuiCacheKey];

                    if (!instanceYuiCacheObj) {

                        instanceYuiConfig = {
                            &#x2F;&#x2F;debug: true,
                            &#x2F;&#x2F;filter: &#x27;debug&#x27;,
                            bootstrap: useOnDemand,
                            &#x2F;&#x2F; This is a list of preferred langs
                            lang: command.context.langs,
                            core: coreYuiModules
                        };

                        instanceYuiCacheObj = CACHE.YUI[instanceYuiCacheKey] =
                            YUI(instanceYuiConfig);

                        logger.log(&#x27;YUI instance created: &#x27; +
                            instance.instanceId,
                            &#x27;mojito&#x27;,
                            &#x27;qeperf&#x27;
                            );
                        logger.log(&#x27;Cached a YUI instance with key: \&#x27;&#x27; +
                            instanceYuiCacheKey + &#x27;\&#x27;&#x27;, &#x27;mojito&#x27;, NAME);
                    } else {
                        logger.log(&#x27;Using cached YUI instance from key:&#x27; +
                            instanceYuiCacheKey, &#x27;mojito&#x27;, &#x27;qeperf&#x27;);
                    }

                    &#x2F;&#x2F; To handle both shared and new instance instead of having
                    &#x2F;&#x2F; if&#x2F;elses.
                    groups[groupKey] = instance.yui.config;
                    instanceYuiCacheObj.applyConfig({groups: groups});

                    cb();
                }

                &#x2F;&#x2F; Get the cached YUI instance (if there is one)
                if (!(appShareYUIInstance &amp;&amp; instance.shareYUIInstance)) {
                    instanceYuiCacheObj = CACHE.YUI[instanceYuiCacheKey];
                }

                &#x2F;*
                 * We cache a YUI instance for each Mojit type requested.
                 * Doing this gives a huge performance benefit at the
                 * cost of a larger memory foot print.
                 *&#x2F;
                if (instanceYuiCacheObj) {
                    runMojit();
                } else if (!usePrecomputed) {
                    modulesLoaded(runMojit);
                } else {

                    logger.log(&#x27;loading YUI modules for YUI instantiation: &#x27; +
                        instance.instanceId, &#x27;mojito&#x27;, &#x27;qeperf&#x27;);

                    loader.load(instance.yui.sortedPaths, function(err) {
                        if (err) {
                            logger.log(err.message, &#x27;error&#x27;, NAME);
                            adapter.error(err);
                            return;
                        }
                        modulesLoaded(runMojit);
                    });
                }
            });
    }


    &#x2F;*
     * the dispatcher must receive the global logger up front, because it is
     * loaded within a Y instance that has the original Y.log function, so in
     * order to have consistent logging, the Mojito logger is passed in and we
     * use it.
     *&#x2F;
    Y.namespace(&#x27;mojito&#x27;).Dispatcher = {

        init: function(resourceStore, coreMojitoYuiModules, globalLogger,
                globalLoader) {
            var appConfigStatic;

            if (!resourceStore) {
                throw new Error(
                    &#x27;Mojito cannot instantiate without a resource store&#x27;
                );
            }

            store = resourceStore;
            coreYuiModules = coreMojitoYuiModules || [];
            logger = globalLogger;
            loader = globalLoader;

            logger.log(&#x27;Dispatcher created&#x27;, &#x27;debug&#x27;, NAME);

            appConfigStatic = store.getAppConfig({}, &#x27;application&#x27;);

            appShareYUIInstance = (false !== appConfigStatic.shareYUIInstance);
            usePrecomputed = appConfigStatic.yui &amp;&amp; (-1 !==
                appConfigStatic.yui.dependencyCalculations.indexOf(&#x27;precomputed&#x27;));
            useOnDemand = appConfigStatic.yui &amp;&amp; (-1 !==
                appConfigStatic.yui.dependencyCalculations.indexOf(&#x27;ondemand&#x27;));
            if (!usePrecomputed) {
                useOnDemand = true;
            }

            if (useOnDemand) {
                coreYuiModules.push(&#x27;loader&#x27;);
            }

            return this;
        },


        &#x2F;&#x2F; Assign outer function here.
        dispatch: dispatch
    };

}, &#x27;0.1.0&#x27;, {requires: [
    &#x27;mojito-controller-context&#x27;,
    &#x27;mojito-util&#x27;,
    &#x27;mojito-resource-store-adapter&#x27;,
    &#x27;intl&#x27;
]});

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="..&#x2F;assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="..&#x2F;assets/js/yui-prettify.js"></script>
<script src="..&#x2F;assets/../api.js"></script>
<script src="..&#x2F;assets/js/api-filter.js"></script>
<script src="..&#x2F;assets/js/api-list.js"></script>
<script src="..&#x2F;assets/js/api-search.js"></script>
<script src="..&#x2F;assets/js/apidocs.js"></script>
</body>
</html>
