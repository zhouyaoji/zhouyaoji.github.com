<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>mojito_src&#x2F;source&#x2F;lib&#x2F;app&#x2F;libs&#x2F;Mulib&#x2F;mu&#x2F;parser.js - Mojito API</title>
    <link rel="stylesheet" href="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;3.5.0&#x2F;build&#x2F;cssgrids&#x2F;cssgrids-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/css/main.css" id="site_styles">
    <script src="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;3.5.0&#x2F;build&#x2F;yui&#x2F;yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="assets&#x2F;img&#x2F;mojito-logo-white-bkg.png" title="Mojito API"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.3.29</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="..&#x2F;classes/ActionContext.html">ActionContext</a></li>
            
                <li><a href="..&#x2F;classes/Analytics.common.html">Analytics.common</a></li>
            
                <li><a href="..&#x2F;classes/Assets.common.html">Assets.common</a></li>
            
                <li><a href="..&#x2F;classes/Carrier.common.html">Carrier.common</a></li>
            
                <li><a href="..&#x2F;classes/Composite.common.html">Composite.common</a></li>
            
                <li><a href="..&#x2F;classes/Config.common.html">Config.common</a></li>
            
                <li><a href="..&#x2F;classes/Cookie.client.html">Cookie.client</a></li>
            
                <li><a href="..&#x2F;classes/Cookie.server.html">Cookie.server</a></li>
            
                <li><a href="..&#x2F;classes/Deploy.server.html">Deploy.server</a></li>
            
                <li><a href="..&#x2F;classes/Device.common.html">Device.common</a></li>
            
                <li><a href="..&#x2F;classes/Http.server.html">Http.server</a></li>
            
                <li><a href="..&#x2F;classes/I13n.server.html">I13n.server</a></li>
            
                <li><a href="..&#x2F;classes/Intl.common.html">Intl.common</a></li>
            
                <li><a href="..&#x2F;classes/Meta.common.html">Meta.common</a></li>
            
                <li><a href="..&#x2F;classes/MojitoDispatcher.html">MojitoDispatcher</a></li>
            
                <li><a href="..&#x2F;classes/MojitoServer.html">MojitoServer</a></li>
            
                <li><a href="..&#x2F;classes/MojitProxy.html">MojitProxy</a></li>
            
                <li><a href="..&#x2F;classes/OutputAdapter.common.html">OutputAdapter.common</a></li>
            
                <li><a href="..&#x2F;classes/OutputHandler.html">OutputHandler</a></li>
            
                <li><a href="..&#x2F;classes/Params.common.html">Params.common</a></li>
            
                <li><a href="..&#x2F;classes/Partial.common.html">Partial.common</a></li>
            
                <li><a href="..&#x2F;classes/ResourceStore.server.html">ResourceStore.server</a></li>
            
                <li><a href="..&#x2F;classes/Url.common.html">Url.common</a></li>
            
                <li><a href="..&#x2F;classes/Y.mojito.Client.html">Y.mojito.Client</a></li>
            
                <li><a href="..&#x2F;classes/Y.mojito.lib.MojitoRouter.html">Y.mojito.lib.MojitoRouter</a></li>
            
                <li><a href="..&#x2F;classes/Y.mojito.lib.REST.html">Y.mojito.lib.REST</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="..&#x2F;modules/ActionContext.html">ActionContext</a></li>
            
                <li><a href="..&#x2F;modules/ActionContextAddon.html">ActionContextAddon</a></li>
            
                <li><a href="..&#x2F;modules/CommonLibs.html">CommonLibs</a></li>
            
                <li><a href="..&#x2F;modules/MojitoClient.html">MojitoClient</a></li>
            
                <li><a href="..&#x2F;modules/MojitoServer.html">MojitoServer</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: mojito_src&#x2F;source&#x2F;lib&#x2F;app&#x2F;libs&#x2F;Mulib&#x2F;mu&#x2F;parser.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
var fs = require(&#x27;fs&#x27;),
        Path    = require(&#x27;path&#x27;),
        Mu = require(&#x27;..&#x2F;Mu&#x27;);

exports.parse = parse;
exports.parseText = parseText;

var otag = &#x27;{{&#x27;;
var ctag = &#x27;}}&#x27;;

function parse(filename, root, ext, callback) {
    fs.readFile(extension(root, filename, ext), function (err, contents) {
        if (err) {
            return callback(err);
        }
        
        Mu.Preprocessor.expandPartials(
            parseText(contents.toString(&quot;utf8&quot;), filename),
            root,
            ext,
            function (err, res) {
                callback(err, res, filename);
            }
        );
    });
}

function parseText(text, filename) {
    filename = filename || &quot;&lt;raw text&gt;&quot;;
    if (!text.split) {
            &#x2F;&#x2F; Cast the passed Object back to aa String.
            text = new String(text);
    }
    var parsed = text.split(&#x27;\n&#x27;).map(function (val, i) {
            return parseLine(i+1, val, filename);
    });
    otag = &#x27;{{&#x27;;
    ctag = &#x27;}}&#x27;;
    return parsed;
}

function parseLine(lineNumber, lineText, filename) {
    if (lineNumber !== 1) {
        lineText = &#x27;\\n&#x27; + lineText;
    }
    
    return {
        number: lineNumber,
        source: lineText,
        filename: filename,
        tokens: actuallyParseLine(lineText)
    };
}

&#x2F;**
 * Responsible for actually parsing lines. Converts them into the following
 * token form:
 * 
 * [
 *     {&#x27;type&#x27;: &#x27;string&#x27;, &#x27;value&#x27;: &#x27;Hello &#x27;},
 *     {&#x27;type&#x27;: &#x27;variable&#x27;, &#x27;value&#x27;: &#x27;name&#x27;}
 * ]
 * 
 * @param {String} text The source text of the line.
 * @returns {Array} The parsed tokens.
 *&#x2F;
function actuallyParseLine(text) {
    var r_otag;
    var r_ctag;
    var r_uctag;
    var r_sdctag;
    
    setTags(otag, ctag);
    
    var ret = [];
    var buffer = &#x27;&#x27;;
    var letter;
    var i = 0;
    
    var state = &#x27;normal&#x27;;
    
    function setTags(o, c) {
        otag = o;
        ctag = c;
        
        r_otag     = new RegExp(escapeRegex(otag) + &#x27;$&#x27;);
        r_ctag     = new RegExp(escapeRegex(ctag) + &#x27;$&#x27;);
        r_uctag    = new RegExp(&#x27;}&#x27; + escapeRegex(ctag) + &#x27;$&#x27;);
        r_sdctag = new RegExp(&#x27;=&#x27; + escapeRegex(ctag) + &#x27;$&#x27;);
    }
    
    var stateTagLookup = {
        &#x27;#&#x27;: &#x27;start_enumerable&#x27;,
        &#x27;^&#x27;: &#x27;start_inverted_enumerable&#x27;,
        &#x27;&#x2F;&#x27;: &#x27;end_enumerable&#x27;,
        &#x27;&gt;&#x27;: &#x27;partial&#x27;,
        &#x27;{&#x27;: &#x27;unescaped&#x27;,
        &#x27;!&#x27;: &#x27;comment&#x27;,
        &#x27;=&#x27;: &#x27;set_delimiter&#x27;
    };
    
    while (letter = text.charAt(i++)) {
        buffer += letter;
        
        switch (state) {
        
        case &#x27;normal&#x27;:
            if (buffer.match(r_otag)) {
                ret.push({
                    type: &#x27;string&#x27;,
                    value: buffer.substring(0, buffer.length - otag.length)
                });

                buffer = &#x27;&#x27;;
                state = &#x27;start_tag&#x27;;
            }
            break;
            
        case &#x27;start_tag&#x27;:
            if (buffer === &#x27; &#x27;) {
                buffer = &#x27;&#x27;;
            } else if (buffer in stateTagLookup) {
                state = stateTagLookup[buffer];
                buffer = &#x27;&#x27;;
            } else if (buffer.match(&#x2F;[a-zA-Z\$_]&#x2F;)) {
                state = &#x27;variable&#x27;;
            }
            break;
            
        case &#x27;variable&#x27;:
        case &#x27;comment&#x27;:
        case &#x27;start_enumerable&#x27;:
        case &#x27;start_inverted_enumerable&#x27;:
        case &#x27;end_enumerable&#x27;:
        case &#x27;partial&#x27;:
            if (buffer.match(r_ctag)) {
                ret.push({
                    type: state,
                    value: buffer.substring(0, buffer.length - ctag.length).trim()
                });
                
                buffer = &#x27;&#x27;;
                state = &#x27;normal&#x27;;
            }
            break;
        
        case &#x27;unescaped&#x27;:
            if (buffer.match(r_uctag)) {
                ret.push({
                    type: &#x27;unescaped&#x27;,
                    value: buffer.substring(0, buffer.length - (ctag.length + 1)).trim()
                });
                
                buffer = &#x27;&#x27;;
                state = &#x27;normal&#x27;;
            }
            break;
        
        case &#x27;set_delimiter&#x27;:
            if (buffer.match(r_sdctag)) {
                var data = buffer.substring(0, buffer.length - (ctag.length + 1)).trim();
                data = data.split(&#x2F; +&#x2F;);
                
                if (data.length === 2) {
                    setTags(data[0], data[1]);
                }
                
                buffer = &#x27;&#x27;;
                state = &#x27;normal&#x27;;
            }
        
        }
    }
    
    if (buffer.length) {
        ret.push({type: &#x27;string&#x27;, value: buffer});
    }
    
    return ret;
}


&#x2F;&#x2F; Private

function token(type, value) {
    return {type: type, value: value};
}

function escapeRegex(text) {
    &#x2F;&#x2F; thank you Simon Willison
    if(!arguments.callee.sRE) {
        var specials = [
            &#x27;&#x2F;&#x27;, &#x27;.&#x27;, &#x27;*&#x27;, &#x27;+&#x27;, &#x27;?&#x27;, &#x27;|&#x27;,
            &#x27;(&#x27;, &#x27;)&#x27;, &#x27;[&#x27;, &#x27;]&#x27;, &#x27;{&#x27;, &#x27;}&#x27;, &#x27;\\&#x27;
        ];
        arguments.callee.sRE = new RegExp(
            &#x27;(\\&#x27; + specials.join(&#x27;|\\&#x27;) + &#x27;)&#x27;, &#x27;g&#x27;
        );
    }
    
    return text.replace(arguments.callee.sRE, &#x27;\\$1&#x27;);
}

function extension(root, filename, ext) {
    return ext ? Path.join(root, filename + &#x27;.&#x27; + ext) :
                             Path.join(root, filename);
}

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="..&#x2F;assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="..&#x2F;assets/js/yui-prettify.js"></script>
<script src="..&#x2F;assets/../api.js"></script>
<script src="..&#x2F;assets/js/api-filter.js"></script>
<script src="..&#x2F;assets/js/api-list.js"></script>
<script src="..&#x2F;assets/js/api-search.js"></script>
<script src="..&#x2F;assets/js/apidocs.js"></script>
</body>
</html>
