<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>mojito_src&#x2F;source&#x2F;lib&#x2F;app&#x2F;addons&#x2F;ac&#x2F;deploy.server.js - Mojito API</title>
    <link rel="stylesheet" href="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;3.5.0&#x2F;build&#x2F;cssgrids&#x2F;cssgrids-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/css/main.css" id="site_styles">
    <script src="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;3.5.0&#x2F;build&#x2F;yui&#x2F;yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="assets&#x2F;img&#x2F;mojito-logo-white-bkg.png" title="Mojito API"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.3.29</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="..&#x2F;classes/ActionContext.html">ActionContext</a></li>
            
                <li><a href="..&#x2F;classes/Analytics.common.html">Analytics.common</a></li>
            
                <li><a href="..&#x2F;classes/Assets.common.html">Assets.common</a></li>
            
                <li><a href="..&#x2F;classes/Carrier.common.html">Carrier.common</a></li>
            
                <li><a href="..&#x2F;classes/Composite.common.html">Composite.common</a></li>
            
                <li><a href="..&#x2F;classes/Config.common.html">Config.common</a></li>
            
                <li><a href="..&#x2F;classes/Cookie.client.html">Cookie.client</a></li>
            
                <li><a href="..&#x2F;classes/Cookie.server.html">Cookie.server</a></li>
            
                <li><a href="..&#x2F;classes/Deploy.server.html">Deploy.server</a></li>
            
                <li><a href="..&#x2F;classes/Device.common.html">Device.common</a></li>
            
                <li><a href="..&#x2F;classes/Http.server.html">Http.server</a></li>
            
                <li><a href="..&#x2F;classes/I13n.server.html">I13n.server</a></li>
            
                <li><a href="..&#x2F;classes/Intl.common.html">Intl.common</a></li>
            
                <li><a href="..&#x2F;classes/Meta.common.html">Meta.common</a></li>
            
                <li><a href="..&#x2F;classes/MojitoDispatcher.html">MojitoDispatcher</a></li>
            
                <li><a href="..&#x2F;classes/MojitoServer.html">MojitoServer</a></li>
            
                <li><a href="..&#x2F;classes/MojitProxy.html">MojitProxy</a></li>
            
                <li><a href="..&#x2F;classes/OutputAdapter.common.html">OutputAdapter.common</a></li>
            
                <li><a href="..&#x2F;classes/OutputHandler.html">OutputHandler</a></li>
            
                <li><a href="..&#x2F;classes/Params.common.html">Params.common</a></li>
            
                <li><a href="..&#x2F;classes/Partial.common.html">Partial.common</a></li>
            
                <li><a href="..&#x2F;classes/ResourceStore.server.html">ResourceStore.server</a></li>
            
                <li><a href="..&#x2F;classes/Url.common.html">Url.common</a></li>
            
                <li><a href="..&#x2F;classes/Y.mojito.Client.html">Y.mojito.Client</a></li>
            
                <li><a href="..&#x2F;classes/Y.mojito.lib.MojitoRouter.html">Y.mojito.lib.MojitoRouter</a></li>
            
                <li><a href="..&#x2F;classes/Y.mojito.lib.REST.html">Y.mojito.lib.REST</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="..&#x2F;modules/ActionContext.html">ActionContext</a></li>
            
                <li><a href="..&#x2F;modules/ActionContextAddon.html">ActionContextAddon</a></li>
            
                <li><a href="..&#x2F;modules/CommonLibs.html">CommonLibs</a></li>
            
                <li><a href="..&#x2F;modules/MojitoClient.html">MojitoClient</a></li>
            
                <li><a href="..&#x2F;modules/MojitoServer.html">MojitoServer</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: mojito_src&#x2F;source&#x2F;lib&#x2F;app&#x2F;addons&#x2F;ac&#x2F;deploy.server.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&#x2F;*
 * Copyright (c) 2011-2012, Yahoo! Inc.  All rights reserved.
 * Copyrights licensed under the New BSD License.
 * See the accompanying LICENSE file for terms.
 *&#x2F;


&#x2F;*jslint anon:true, sloppy:true, nomen:true*&#x2F;
&#x2F;*global YUI*&#x2F;


&#x2F;**
 * @module ActionContextAddon
 *&#x2F;
YUI.add(&#x27;mojito-deploy-addon&#x27;, function(Y, NAME) {

    var fs = require(&#x27;fs&#x27;),
        yuiFilter = &#x27;min&#x27;,
        minify;


    if (YUI._mojito &amp;&amp; YUI._mojito.DEBUG) {
        yuiFilter = &#x27;debug&#x27;;
    }


    &#x2F;&#x2F; TODO: [Issue 64] improve this, it&#x27;s a poor man&#x27;s minify.
    &#x2F;&#x2F; a. build minification into static handler?
    &#x2F;&#x2F; b. build minification into prod-build script ?
    &#x2F;&#x2F; c. build minification into server-start?
    minify = function(str) {
        &#x2F;&#x2F; Remove comment blocks &#x2F;* ... *&#x2F; and
        &#x2F;&#x2F; remove white space at the start of lines
        return str.replace(&#x2F;\&#x2F;\*[\s\S]*?\*\&#x2F;&#x2F;g, &#x27;&#x27;).
            replace(&#x2F;^[ \t\r\n]+&#x2F;gm, &#x27;&#x27;);
    };


    &#x2F;**
     * &lt;strong&gt;Access point:&lt;&#x2F;strong&gt; &lt;em&gt;ac.deploy.*&lt;&#x2F;em&gt;
     * Provides ability to create client runtime deployment HTML
     * @class Deploy.server
     *&#x2F;
    function Addon(command, adapter, ac) {
        this.instance = command.instance;
        this.scripts = {};
        this.ac = ac;
    }


    Addon.prototype = {

        namespace: &#x27;deploy&#x27;,

        &#x2F;**
         * Declaration of store requirement.
         * @method setStore
         * @private
         * @param {ResourceStore} rs The resource store instance.
         *&#x2F;
        setStore: function(rs) {
            this.rs = rs;
            if (rs) {
                Y.log(&#x27;Initialized and activated with Resource Store&#x27;, &#x27;info&#x27;,
                        NAME);
            }
        },

        &#x2F;**
         * Builds up the browser Mojito runtime.
         * @method constructMojitoClientRuntime
         * @param {AssetHandler} assetHandler asset handler used to add scripts
         *     to the DOM under construction.
         * @param {object} binderMap information about the binders that will be
         *     deployed to the client.
         *&#x2F;
        constructMojitoClientRuntime: function(assetHandler, binderMap) {

            &#x2F;&#x2F;Y.log(&#x27;Constructing Mojito client runtime&#x27;, &#x27;debug&#x27;, NAME);

            var store = this.rs,
                contextServer = this.ac.context,
                appConfigServer = store.getAppConfig(contextServer,
                    &#x27;application&#x27;),
                contextClient,
                appConfigClient,
                yuiConfig = {},
                yuiConfigEscaped,
                yuiConfigStr,
                yuiModules,
                loader,
                yuiCombo,
                yuiJsUrls = [],
                yuiCssUrls = [],
                yuiJsUrlContains = {},
                viewId,
                binder,
                i,
                id,
                instances = {},
                clientConfig = {},
                clientConfigEscaped,
                clientConfigStr,
                usePrecomputed,
                useOnDemand,
                initialModuleList,
                initializer, &#x2F;&#x2F; script for YUI initialization
                routeMaker,
                type,
                module,
                path,
                pathToRoot;

            contextClient = Y.mojito.util.copy(contextServer);
            contextClient.runtime = &#x27;client&#x27;;
            appConfigClient = store.getAppConfig(contextClient, &#x27;application&#x27;);
            clientConfig.context = contextClient;

            if (appConfigClient.yui &amp;&amp; appConfigClient.yui.config) {
                yuiConfig = appConfigClient.yui.config;
            }
            yuiConfig.lang = contextServer.lang; &#x2F;&#x2F; same as contextClient.lang
            yuiConfig.core = yuiConfig.core || [];
            yuiConfig.core = yuiConfig.core.concat(
                [&#x27;get&#x27;, &#x27;features&#x27;, &#x27;intl-base&#x27;, &#x27;yui-log&#x27;, &#x27;mojito&#x27;,
                    &#x27;yui-later&#x27;]
            );

            &#x2F;&#x2F; If we have a &quot;base&quot; for YUI use it
            if (appConfigClient.yui &amp;&amp; appConfigClient.yui.base) {
                yuiConfig.base = appConfigClient.yui.base;
                yuiConfig.combine = false;
            }

            &#x2F;&#x2F; If we know where yui &quot;Loader&quot; is tell YUI
            if (appConfigClient.yui &amp;&amp; appConfigClient.yui.loader) {
                yuiConfig.loaderPath = appConfigClient.yui.loader;
            }

            clientConfig.store = store.serializeClientStore(contextClient,
                instances);

            usePrecomputed = appConfigServer.yui &amp;&amp;
                appConfigServer.yui.dependencyCalculations &amp;&amp; (-1 !==
                appConfigServer.yui.dependencyCalculations.indexOf(
                        &#x27;precomputed&#x27;
                    ));
            useOnDemand = appConfigServer.yui &amp;&amp;
                appConfigServer.yui.dependencyCalculations &amp;&amp; (-1 !==
                appConfigServer.yui.dependencyCalculations.indexOf(
                        &#x27;ondemand&#x27;
                    ));
            if (!usePrecomputed) {
                useOnDemand = true;
            }

            &#x2F;&#x2F; Set the YUI URL to use on the client (This has to be done
            &#x2F;&#x2F; before any other scripts are added)
            if (appConfigClient.yui &amp;&amp; appConfigClient.yui.url) {
                yuiJsUrls.push(appConfigClient.yui.url);
                &#x2F;&#x2F; Since the user has given their own rollup of YUI library
                &#x2F;&#x2F; modules, we need some way of knowing which YUI library
                &#x2F;&#x2F; modules went into that rollup.
                if (Y.Lang.isArray(appConfigClient.yui.urlContains)) {
                    for (i = 0; i &lt; appConfigClient.yui.urlContains.length;
                            i += 1) {
                        yuiJsUrlContains[appConfigClient.yui.urlContains[i]] =
                            true;
                    }
                }
            } else {
                &#x2F;&#x2F; YUI 3.4.1 doesn&#x27;t have actual rollup files, so we need to
                &#x2F;&#x2F; specify all the parts directly.
                yuiModules = [&#x27;yui-base&#x27;];
                yuiJsUrlContains[&#x27;yui-base&#x27;] = true;
                yuiModules = [&#x27;yui&#x27;];
                yuiJsUrlContains.yui = true;
                if (useOnDemand) {
                    yuiModules.push(&#x27;get&#x27;);
                    yuiJsUrlContains.get = true;
                    yuiModules.push(&#x27;loader-base&#x27;);
                    yuiJsUrlContains[&#x27;loader-base&#x27;] = true;
                    yuiModules.push(&#x27;loader-rollup&#x27;);
                    yuiJsUrlContains[&#x27;loader-rollup&#x27;] = true;
                    yuiModules.push(&#x27;loader-yui3&#x27;);
                    yuiJsUrlContains[&#x27;loader-yui3&#x27;] = true;
                    for (i = 0; i &lt; store.store._fwConfig.
                            ondemandBaseYuiModules.length; i += 1) {
                        module =
                            store.store._fwConfig.ondemandBaseYuiModules[i];
                        yuiModules.push(module);
                        yuiJsUrlContains[module] = true;
                    }
                }
                if (appConfigClient.yui &amp;&amp; appConfigClient.yui.extraModules) {
                    for (i = 0; i &lt; appConfigClient.yui.extraModules.length;
                            i += 1) {
                        yuiModules.push(appConfigClient.yui.extraModules[i]);
                        yuiJsUrlContains[
                            appConfigClient.yui.extraModules[i]
                        ] = true;
                    }
                }
                for (viewId in binderMap) {
                    if (binderMap.hasOwnProperty(viewId)) {
                        binder = binderMap[viewId];
                        for (module in binder.needs) {
                            if (binder.needs.hasOwnProperty(module)) {
                                path = binder.needs[module];
                                &#x2F;&#x2F; Anything we don&#x27;t know about we&#x27;ll assume is
                                &#x2F;&#x2F; a YUI library module.
                                if (!store.fileFromStaticHandlerURL(path)) {
                                    yuiModules.push(module);
                                    yuiJsUrlContains[module] = true;
                                }
                            }
                        }
                    }
                }

                loader = new Y.mojito.Loader(appConfigClient);
                yuiCombo = loader.createYuiLibComboUrl(yuiModules, yuiFilter);
                yuiJsUrls = yuiCombo.js;
                yuiCssUrls = yuiCombo.css;
            }
            for (i = 0; i &lt; yuiJsUrls.length; i += 1) {
                this.addScript(&#x27;top&#x27;, yuiJsUrls[i]);
            }
            &#x2F;&#x2F; defaults to true if missing
            if (!yuiConfig.hasOwnProperty(&#x27;fetchCSS&#x27;) || yuiConfig.fetchCSS) {
                for (i = 0; i &lt; yuiCssUrls.length; i += 1) {
                    assetHandler.addCss(yuiCssUrls[i], &#x27;top&#x27;);
                }
            }

            &#x2F;&#x2F; add mojito bootstrap
            &#x2F;&#x2F; With &quot;precomputed&quot; the scripts are listed as binder dependencies
            &#x2F;&#x2F; and thus loaded that way.  However, with &quot;ondemand&quot; we&#x27;ll use
            &#x2F;&#x2F; the YUI loader which we haven&#x27;t (yet) taught where to find the
            &#x2F;&#x2F; fw &amp; app scripts.
            if (useOnDemand) {
                &#x2F;&#x2F; add all framework-level and app-level code
                this.addScripts(&#x27;bottom&#x27;, store.getYuiConfigFw(&#x27;client&#x27;,
                    contextClient).modules);
                this.addScripts(&#x27;bottom&#x27;, store.getYuiConfigApp(&#x27;client&#x27;,
                    contextClient).modules);
            }

            &#x2F;&#x2F; add binders&#x27; dependencies
            for (viewId in binderMap) {
                if (binderMap.hasOwnProperty(viewId)) {
                    binder = binderMap[viewId];
                    for (module in binder.needs) {
                        if (binder.needs.hasOwnProperty(module)) {
                            if (!yuiJsUrlContains[module]) {
                                this.addScript(&#x27;bottom&#x27;, binder.needs[module]);
                            }
                        }
                    }
                }
            }

            clientConfig.binderMap = binderMap;

            &#x2F;&#x2F; TODO: [Issue 65] Split the app config in to server client
            &#x2F;&#x2F; sections.
            &#x2F;&#x2F; we need the app config on the client for log levels (at least)
            clientConfig.appConfig = clientConfig.store.appConfig;

            &#x2F;&#x2F; this is mainly used by html5app
            pathToRoot = this.ac.http.getHeader(&#x27;x-mojito-build-path-to-root&#x27;);
            if (pathToRoot) {
                clientConfig.pathToRoot = pathToRoot;
            }

            &#x2F;&#x2F; TODO -- decide if this is necessary, since
            &#x2F;&#x2F; clientConfig.store.mojits is currently unpopulated
            &#x2F;*
            for (type in clientConfig.store.mojits) {
                for (i in clientConfig.store.mojits[type].yui.sorted) {
                    module = clientConfig.store.mojits[type].yui.sorted[i];
                    path = clientConfig.store.mojits[type].yui.sortedPaths[
                        module];
                    this.scripts[path] = &#x27;bottom&#x27;;
                }
            }
            *&#x2F;

            routeMaker = new Y.mojito.RouteMaker(clientConfig.store.routes);
            clientConfig.routes = routeMaker.getComputedRoutes();
            delete clientConfig.store;

            initialModuleList = &quot;&#x27;*&#x27;&quot;;
            if (useOnDemand) {
                initialModuleList = &quot;&#x27;mojito-client&#x27;&quot;;
            }

            &#x2F;&#x2F; Unicode escape the various strings in the config data to help
            &#x2F;&#x2F; fight against possible script injection attacks.
            yuiConfigEscaped = Y.mojito.util.cleanse(yuiConfig);
            yuiConfigStr = Y.JSON.stringify(yuiConfigEscaped);
            clientConfigEscaped = Y.mojito.util.cleanse(clientConfig);
            clientConfigStr = Y.JSON.stringify(clientConfigEscaped);

            initializer = &#x27;&lt;script type=&quot;text&#x2F;javascript&quot;&gt;\n&#x27; +
                &#x27;    YUI_config = &#x27; + yuiConfigStr + &#x27;;\n&#x27; +
                &#x27;    YUI().use(&#x27; + initialModuleList + &#x27;, function(Y) {\n&#x27; +
                &#x27;    window.YMojito = { client: new Y.mojito.Client(&#x27; +
                clientConfigStr + &#x27;) };\n&#x27; +
                &#x27;        });\n&#x27; +
                &#x27;&lt;&#x2F;script&gt;\n&#x27;;

            &#x2F;&#x2F; Add all the scripts we have collected
            assetHandler.addAssets(
                this.getScripts(appConfigServer.embedJsFilesInHtmlFrame)
            );
            &#x2F;&#x2F; Add the boot script
            assetHandler.addAsset(&#x27;blob&#x27;, &#x27;bottom&#x27;, initializer);
        },


        addScript: function(position, path) {
            this.scripts[path] = position;
        },


        addScripts: function(position, modules) {
            var i;
            for (i in modules) {
                if (modules.hasOwnProperty(i)) {
                    this.scripts[modules[i].fullpath] = position;
                }
            }
        },


        &#x2F;**
         * TODO: [Issue 66] This can be made faster with a single for
         * loop and caching.
         *
         * Note: A single SCRIPT tag containing all the JS on the pages is
         * slower than many SCRIPT tags (checked on iPad only).
         * @method getScripts
         * @private
         * @param {bool} embed Should returned scripts be embedded in script
         *     tags.
         * @return {object} An object containing script descriptors.
         *&#x2F;
        getScripts: function(embed) {
            var i,
                x,
                assets = {},
                blob = {
                    type: &#x27;blob&#x27;,
                    position: &#x27;bottom&#x27;,
                    content: &#x27;&#x27;
                };

            &#x2F;&#x2F; Walk over the scripts and check what we can do
            for (i in this.scripts) {
                if (this.scripts.hasOwnProperty(i)) {
                    if (embed &amp;&amp; this.rs._staticURLs[i]) {
                        &#x2F;&#x2F;blob.content+= fs.readFileSync(this.rs._staticURLs[i],
                        &#x2F;&#x2F;      &#x27;utf8&#x27;);
                        &#x2F;&#x2F;delete this.scripts[i];
                        this.scripts[i] = {
                            type: &#x27;blob&#x27;,
                            position: &#x27;bottom&#x27;,
                            content: &#x27;&lt;script type=&quot;text&#x2F;javascript&quot;&gt;&#x27; +
                                minify(fs.readFileSync(this.rs._staticURLs[i],
                                    &#x27;utf8&#x27;)) + &#x27;&lt;&#x2F;script&gt;&#x27;
                        };
                    } else {
                        this.scripts[i] = {
                            type: &#x27;js&#x27;,
                            position: this.scripts[i],
                            content: i
                        };
                    }
                }
            }


            &#x2F;&#x2F; Convert the scripts to the Assets format
            for (x in this.scripts) {
                if (this.scripts.hasOwnProperty(x)) {
                    if (!assets[this.scripts[x].position]) {
                        assets[this.scripts[x].position] = {};
                    }
                    if (!assets[this.scripts[x].position][this.scripts[x].
                            type]) {
                        assets[this.scripts[x].position][this.scripts[x].
                                type] = [];
                    }
                    assets[this.scripts[x].position][this.scripts[x].type].push(
                        this.scripts[x].content
                    );
                }
            }

            return assets;
        }
    };

    Y.namespace(&#x27;mojito.addons.ac&#x27;).deploy = Addon;

}, &#x27;0.1.0&#x27;, {requires: [
    &#x27;mojito-loader&#x27;,
    &#x27;mojito-util&#x27;,
    &#x27;mojito-http-addon&#x27;
]});

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="..&#x2F;assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="..&#x2F;assets/js/yui-prettify.js"></script>
<script src="..&#x2F;assets/../api.js"></script>
<script src="..&#x2F;assets/js/api-filter.js"></script>
<script src="..&#x2F;assets/js/api-list.js"></script>
<script src="..&#x2F;assets/js/api-search.js"></script>
<script src="..&#x2F;assets/js/apidocs.js"></script>
</body>
</html>
